# Deploy Pipeline - AWS Deployment
name: Deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'infrastructure/**'
      - 'package.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '18'
  AWS_REGION: us-east-1

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      api_endpoint: ${{ steps.terraform.outputs.api_endpoint }}
      iot_endpoint: ${{ steps.terraform.outputs.iot_endpoint }}
    
    defaults:
      run:
        working-directory: infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=scada-topology/${{ github.event.inputs.environment || 'dev' }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment || 'dev' }}" \
            -var="project_name=scada-topology" \
            -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform
        run: |
          echo "api_endpoint=$(terraform output -raw api_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "iot_endpoint=$(terraform output -raw iot_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT

  deploy-lambda:
    name: Deploy Lambda Functions
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci --production=false

      - name: Build
        run: npm run build

      - name: Package Lambda functions
        run: |
          cd dist
          mkdir -p lambda-packages
          
          # Package ingest function
          zip -r lambda-packages/ingest.zip lambda/ingest/ utils/ database/
          
          # Package process function
          zip -r lambda-packages/process.zip lambda/process/ processors/ utils/ database/
          
          # Package query function
          zip -r lambda-packages/query.zip lambda/query/ utils/ database/
          
          # Package export function
          zip -r lambda-packages/export.zip lambda/export/ utils/ database/

      - name: Deploy Ingest Lambda
        run: |
          aws lambda update-function-code \
            --function-name scada-topology-${{ github.event.inputs.environment || 'dev' }}-ingest \
            --zip-file fileb://dist/lambda-packages/ingest.zip

      - name: Deploy Process Lambda
        run: |
          aws lambda update-function-code \
            --function-name scada-topology-${{ github.event.inputs.environment || 'dev' }}-process \
            --zip-file fileb://dist/lambda-packages/process.zip

      - name: Deploy Query Lambda
        run: |
          aws lambda update-function-code \
            --function-name scada-topology-${{ github.event.inputs.environment || 'dev' }}-query \
            --zip-file fileb://dist/lambda-packages/query.zip

      - name: Deploy Export Lambda
        run: |
          aws lambda update-function-code \
            --function-name scada-topology-${{ github.event.inputs.environment || 'dev' }}-export \
            --zip-file fileb://dist/lambda-packages/export.zip

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get database credentials from Secrets Manager
        id: secrets
        run: |
          DB_CREDS=$(aws secretsmanager get-secret-value \
            --secret-id scada-topology-${{ github.event.inputs.environment || 'dev' }}-db-credentials \
            --query SecretString --output text)
          echo "::add-mask::$(echo $DB_CREDS | jq -r '.password')"
          echo "db_host=$(echo $DB_CREDS | jq -r '.host')" >> $GITHUB_OUTPUT
          echo "db_port=$(echo $DB_CREDS | jq -r '.port')" >> $GITHUB_OUTPUT
          echo "db_name=$(echo $DB_CREDS | jq -r '.database')" >> $GITHUB_OUTPUT
          echo "db_user=$(echo $DB_CREDS | jq -r '.username')" >> $GITHUB_OUTPUT
          echo "db_password=$(echo $DB_CREDS | jq -r '.password')" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        run: npm run migrate
        env:
          DATABASE_HOST: ${{ steps.secrets.outputs.db_host }}
          DATABASE_PORT: ${{ steps.secrets.outputs.db_port }}
          DATABASE_NAME: ${{ steps.secrets.outputs.db_name }}
          DATABASE_USER: ${{ steps.secrets.outputs.db_user }}
          DATABASE_PASSWORD: ${{ steps.secrets.outputs.db_password }}
          DATABASE_SSL: 'true'

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-lambda, run-migrations]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Health Check
        run: |
          API_ENDPOINT="${{ needs.deploy-infrastructure.outputs.api_endpoint }}"
          if [ -n "$API_ENDPOINT" ]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/health")
            if [ "$response" == "200" ]; then
              echo "✅ Health check passed"
            else
              echo "❌ Health check failed with status $response"
              exit 1
            fi
          else
            echo "⚠️ API endpoint not available, skipping health check"
          fi

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-lambda, run-migrations, smoke-test]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.smoke-test.result }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
            echo "API Endpoint: ${{ needs.deploy-infrastructure.outputs.api_endpoint }}"
          else
            echo "❌ Deployment failed"
            exit 1
          fi
